import { useState } from 'react';
import { Button } from './ui/button';
import { Input } from './ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from './ui/select';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from './ui/alert-dialog';
import { CATEGORIES, type Expense } from '@/types';
import { Pencil, Trash2, Search } from 'lucide-react';
import { formatCurrency, formatDate } from '@/utils/helpers';

interface ExpenseTableProps {
  expenses: Expense[];
  onEdit: (expense: Expense) => void;
  onDelete: (id: string) => void;
}

export default function ExpenseTable({ expenses, onEdit, onDelete }: ExpenseTableProps) {
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('Alle Kategorien');
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [expenseToDelete, setExpenseToDelete] = useState<string | null>(null);

  // Filter und Suche
  const filteredExpenses = expenses.filter((expense) => {
    const matchesSearch = expense.description
      .toLowerCase()
      .includes(searchTerm.toLowerCase());
    const matchesCategory =
      categoryFilter === 'Alle Kategorien' || expense.category === categoryFilter;
    return matchesSearch && matchesCategory;
  });

  // Sortiere nach Datum (neueste zuerst)
  const sortedExpenses = [...filteredExpenses].sort(
    (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
  );

  const handleDeleteClick = (id: string) => {
    setExpenseToDelete(id);
    setDeleteDialogOpen(true);
  };

  const confirmDelete = () => {
    if (expenseToDelete) {
      onDelete(expenseToDelete);
      setExpenseToDelete(null);
    }
    setDeleteDialogOpen(false);
  };

  return (
    <div className="space-y-4">
      {/* Filter & Suche */}
      <div className="flex flex-col sm:flex-row gap-3">
        {/* Suchfeld */}
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-zinc-400" />
          <Input
            type="text"
            placeholder="Suche nach Beschreibung..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="pl-10 bg-zinc-900 border-zinc-800"
          />
        </div>

        {/* Kategorie-Filter */}
        <Select value={categoryFilter} onValueChange={setCategoryFilter}>
          <SelectTrigger className="w-full sm:w-[220px] bg-zinc-900 border-zinc-800">
            <SelectValue placeholder="Kategorie filtern" />
          </SelectTrigger>
          <SelectContent>
            {CATEGORIES.map((category) => (
              <SelectItem key={category} value={category}>
                {category}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Desktop Table */}
      <div className="hidden md:block overflow-x-auto rounded-lg border-2 border-zinc-800">
        <table className="w-full">
          <thead className="bg-zinc-900">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-semibold text-zinc-300">Datum</th>
              <th className="px-4 py-3 text-left text-sm font-semibold text-zinc-300">Beschreibung</th>
              <th className="px-4 py-3 text-left text-sm font-semibold text-zinc-300">Kategorie</th>
              <th className="px-4 py-3 text-left text-sm font-semibold text-zinc-300">Zahlungsmethode</th>
              <th className="px-4 py-3 text-right text-sm font-semibold text-zinc-300">Betrag</th>
              <th className="px-4 py-3 text-right text-sm font-semibold text-zinc-300">Aktionen</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-zinc-800">
            {sortedExpenses.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-4 py-8 text-center text-zinc-400">
                  Keine Ausgaben gefunden
                </td>
              </tr>
            ) : (
              sortedExpenses.map((expense) => (
                <tr
                  key={expense.id}
                  className="bg-zinc-950 hover:bg-zinc-900 transition-colors"
                >
                  <td className="px-4 py-3 text-sm text-zinc-300">
                    {formatDate(expense.date)}
                  </td>
                  <td className="px-4 py-3 text-sm text-zinc-100 font-medium">
                    {expense.description}
                  </td>
                  <td className="px-4 py-3 text-sm text-zinc-300">
                    {expense.category}
                  </td>
                  <td className="px-4 py-3 text-sm text-zinc-300">
                    {expense.paymentMethod}
                  </td>
                  <td className="px-4 py-3 text-sm text-right font-semibold text-zinc-100">
                    {formatCurrency(expense.amount)}
                  </td>
                  <td className="px-4 phandleDeleteClick(expense.id)ize="sm"
                        onClick={() => onEdit(expense)}
                        className="h-8 w-8 p-0 text-blue-400 hover:text-blue-300 hover:bg-blue-950"
                      >
                        <Pencil className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => {
                          if (confirm('Möchtest du diese Ausgabe wirklich löschen?')) {
                            onDelete(expense.id);
                          }
                        }}
                        className="h-8 w-8 p-0 text-red-400 hover:text-red-300 hover:bg-red-950"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Mobile Cards */}
      <div className="md:hidden space-y-3">
        {sortedExpenses.length === 0 ? (
          <div className="text-center py-8 text-zinc-400">Keine Ausgaben gefunden</div>
        ) : (
          sortedExpenses.map((expense) => (
            <div
              key={expense.id}
              className="bg-zinc-900 border-2 border-zinc-800 rounded-lg p-4 space-y-3"
            >
              <div className="flex justify-between items-start">
                <div className="flex-1">
                  <div className="font-semibold text-zinc-100">{expense.description}</div>
                  <div className="text-sm text-zinc-400 mt-1">{formatDate(expense.date)}</div>
                </div>
                <div className="text-right">
                  <div className="font-bold text-zinc-100">{formatCurrency(expense.amount)}</div>
                </div>
              </div>

              <div className="flex gap-2 text-sm">
                <span className="px-2 py-1 rounded bg-zinc-800 text-zinc-300">
                  {expense.category}
                </span>
                <span className="px-2 py-1 rounded bg-zinc-800 text-zinc-300">
                  {expense.paymentMethod}
                </span>
              </div>

              <div className="flex gap-2 pt-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => onEdit(expense)}
                  className="flex-1 gap-2"
                >
                  <Pencil className="h-4 w-4" />
                  Bearbeiten
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    if (confirm('Möchtest du diese Ausgabe wirklich löschen?')) {
                      onDelete(expense.id);
                    }
                  }}handleDeleteClick(expense.id)öschen
                </Button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Summary */}
      {sortedExpenses.length > 0 && (
        <div className="flex justify-between items-center px-4 py-3 bg-zinc-900 border-2 border-zinc-800 rounded-lg">
          <span className="text-sm text-zinc-400">
            {sortedExpenses.length} {sortedExpenses.length === 1 ? 'Ausgabe' : 'Ausgaben'}
          </span>
          <span className="text-sm font-semibold text-zinc-100">
            Gesamt: {formatCurrency(sortedExpenses.reduce((sum, exp) => sum + exp.amount, 0))}
          </span>
        </div>
      )}
    </div>
  );
}
  
      {/* Delete Confirmation Dialog */}
      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Ausgabe löschen?</AlertDialogTitle>
            <AlertDialogDescription>
              Diese Aktion kann nicht rückgängig gemacht werden. Die Ausgabe wird dauerhaft gelöscht.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Abbrechen</AlertDialogCancel>
            <AlertDialogAction
              onClick={confirmDelete}
              className="bg-red-600 hover:bg-red-700"
            >
              Löschen
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    